<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme" content="hugo-academic">
  <meta name="generator" content="Hugo 0.52" />
  <meta name="author" content="Mark Cherrie">
  <meta name="description" content="Postdoctoral Researcher in Environment and Health">

  
  
  
    
  
  
    
    
    <link rel="stylesheet" href="/css/highlight.min.css">
    
  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha512-6MXa8B6uaO18Hid6blRMetEIoPqHf7Ux1tnyIQdpt9qI5OACx7C+O3IVTr98vwGnlcg0LOLa02i9Y1HpVhlfiw==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.0/css/academicons.min.css" integrity="sha512-GGGNUPDhnG8LEAEDsjqYIQns+Gu8RBs4j5XGlxl7UfRaZBhCCm5jenJkeJL8uPuOXGqgl8/H1gjlWQDRjd3cUQ==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw==" crossorigin="anonymous">
  
  
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather%7CRoboto+Mono">
  <link rel="stylesheet" href="/css/hugo-academic.css">
  

  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-104259166-1', 'auto');
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  

  <link rel="alternate" href="/index.xml" type="application/rss+xml" title="Mark Cherrie">
  <link rel="feed" href="/index.xml" type="application/rss+xml" title="Mark Cherrie">

  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/apple-touch-icon.png">

  <link rel="canonical" href="/post/netcdf-in-r/">

  

  <title>NetCDF in R | Mark Cherrie</title>

</head>
<body id="top" data-spy="scroll" data-target="#navbar-main" data-offset="71">

<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Mark Cherrie</a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      <ul class="nav navbar-nav navbar-right">
        

        

        <li class="nav-item">
          <a href="/#about">
            
            <span>Home</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#projects">
            
            <span>Projects</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#publications_selected">
            
            <span>Publications</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#talks">
            
            <span>Presentations</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#posts">
            
            <span>Posts</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#contact">
            
            <span>Contact</span>
          </a>
        </li>

        
        

        
      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  


  <div class="article-container">
    <h1 itemprop="name">NetCDF in R</h1>
    

<div class="article-metadata">

  <span class="article-date">
    <time datetime="2018-02-24 00:00:00 &#43;0000 UTC" itemprop="datePublished">
      Sat, Feb 24, 2018
    </time>
  </span>

  
  
  
  <span class="article-categories">
    <i class="fa fa-folder"></i>
    
    <a href="/categories/data-processing">Data Processing</a
    >
    
  </span>
  
  

  
  
  
  <span class="article-tags">
    <i class="fa fa-tags"></i>
    
    <a href="/tags/r">R</a
    >, 
    
    <a href="/tags/netcdf">NetCDF</a
    >, 
    
    <a href="/tags/data">Data</a
    >, 
    
    <a href="/tags/time-series">Time series</a
    >, 
    
    <a href="/tags/satellite">Satellite</a
    >
    
  </span>
  
  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=%2fpost%2fnetcdf-in-r%2f"
         target="_blank">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=NetCDF%20in%20R&amp;url=%2fpost%2fnetcdf-in-r%2f"
         target="_blank">
        <i class="fa fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2fpost%2fnetcdf-in-r%2f&amp;title=NetCDF%20in%20R"
         target="_blank">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=%2fpost%2fnetcdf-in-r%2f&amp;title=NetCDF%20in%20R"
         target="_blank">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=NetCDF%20in%20R&amp;body=%2fpost%2fnetcdf-in-r%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>

    <div class="article-style" itemprop="articleBody">
      


<p>NetCDF stands for “Network Common Data Format” and was created by ‘unidata’ for handling large geospatial data. Here’s a short description from their <a href="https://www.unidata.ucar.edu/netcdf/">website</a>:</p>
<p>“NetCDF is a set of software libraries and self-describing, machine-independent data formats that support the creation, access, and sharing of array-orientated scientific data.”</p>
<p>NetCDF files are containers for dimensions, variables and global atttributes. It’s used to store climatology, meteorology and oceanography data by over 1,300 organisations including <a href="https://www.esrl.noaa.gov/psd/data/gridded/data.gistemp.html">NOAA</a> and <a href="https://www.eumetsat.int/website/home/index.html">EUMETSAT</a>. I think the key advantage of the format is that all the information required to use it correctly is supplied within the data file. So it doesn’t matter if you are using Python, Perl or R, you will be able to read, manipulate and plot the data, and there is lots of information out there to help with that.</p>
<p>I was asked recently to help with processing air pollution data stored in NetCDF format (.nc/.NC) using R. I’ve had a first attempt at describing one of the files we are using (NO2 max for a day), plotting, batch processing daily neighbourhood (postcode unit) based exposure estimates and finally converting to .rds for upload to a postgresql database. Some considerations of the data I was using was that it had a polar stereographic projection, which can be converted to a lat/long <a href="https://stackoverflow.com/questions/23837918/convert-polar-stereographic-projection-into-lat-long-grid-in-r">grid</a>. I decided that this might not be required if I used the points as they were and allocate the nearest air pollution point to the centroid of the postcode. As the data size was quite large (all postcode units in britain) the normal rgeos::gDistance method didn’t work (i.e. could not allocate vector error), so I used k-nearest neighbour (k=1), below is the code:</p>
<pre class="r"><code># reading ncdf in R
library(ncdf4)
library(reshape2)
library(dplyr)
library(raster)

# get all netcdf files
flist &lt;- list.files(path = &quot;.&quot;, pattern = &quot;^.*\\.(nc|NC|Nc|Nc)$&quot;)

# Open a connection to the first file in our list
nc &lt;- nc_open(flist[1])

# get variable names
attributes(nc$var)$names

# summary
MaxNO2&lt;-ncatt_get(nc, attributes(nc$var)$names[3])

#projection is:
#projection: Stereographic
#projection_params: 90.0 -32.0 0.933013
# got this from the nc output
nc_close(nc)

# use the info collected from attributes to get the data
xyznames &lt;- c(&quot;lon&quot;, &quot;lat&quot;, &quot;NO2_daymax&quot;)
lon &lt;- raster(flist[1], varname= xyznames[1])
lat &lt;- raster(flist[1], varname= xyznames[2])
dat &lt;- brick(flist[1], varname = xyznames[3])

# Values drops the &quot;raster&quot; wrapper, just returns values in order as a vector
d &lt;- cbind(values(lon), values(lat), values(dat[[1]]))
# remap arbitrary values to [0,1] for a colour table
scl &lt;- function(x) (x - min(x, na.rm = TRUE))/diff(range(x, na.rm = TRUE))
# set a number for colours
n &lt;- 56
# plot the data
plot(d[,1:2], pch = 16, col = terrain.colors(n)[scl(d[,3]) * (n-1) + 1])

# codepoint postcode unit points
set1&lt;-readRDS(&quot;C:/Users/mcherrie/boundary/Postcodeunit.rds&quot;)
set1 &lt;- spTransform(set1, CRS(&quot;+init=epsg:4326&quot;))

# raster vals
coords = cbind(d[,1], d[,2])
set2 = SpatialPoints(coords)
proj4string(set2) = CRS(&quot;+init=epsg:4326&quot;)
plot(set2)

A &lt;- SpatialPoints(set1)
B &lt;- SpatialPoints(set2)
# library(rgeos)
# set1$nearest_in_set2 &lt;- apply(gDistance(set1sp, set2sp, byid=TRUE), 1, which.min)
# doesn&#39;t work cannot allocate vector

library(SearchTrees)
# Find indices of the nearest points in B to each of the points in A
tree &lt;- createTree(coordinates(B))
inds &lt;- knnLookup(tree, newdat=coordinates(A), k=1)

# create the dataframes --- need to double check this bit!
Bdf&lt;-as.data.frame(B)
Bdf$ind&lt;-seq(1,nrow(Bdf))
colnames(Bdf)&lt;-c(&quot;AP_long&quot;, &quot;AP_lat&quot;, &quot;ind&quot;)
Adf&lt;-as.data.frame(A)
Adf$ind&lt;-inds
colnames(Adf)&lt;-c(&quot;PU_long&quot;, &quot;PU_lat&quot;, &quot;ind&quot;)
Cdf&lt;-merge(Adf, Bdf, by=&quot;ind&quot;)

# get the Air pollution coordinates for the Postcode units
PUDF&lt;-as.data.frame(set1)
colnames(PUDF)&lt;-c(&quot;PU&quot;, &quot;Easting&quot;, &quot;Northing&quot;, &quot;PU_long&quot;, &quot;PU_lat&quot;)
PUDF2&lt;-merge(PUDF, Cdf, by=c(&quot;PU_long&quot;, &quot;PU_lat&quot;), all.x=T)
subsetAP&lt;-subset(PUDF2, select=c(&quot;PU&quot;, &quot;AP_long&quot;, &quot;AP_lat&quot;))

# Let&#39;s output a year
for(i in 1:2){
d &lt;- cbind(values(lon), values(lat), values(dat[[i]]))
name&lt;-dat[[i]]@z[[1]][1]
colnames(d)&lt;-c(&quot;AP_long&quot;, &quot;AP_lat&quot;, &quot;Value&quot;)
d2&lt;-merge(d, subsetAP, by=c(&quot;AP_long&quot;, &quot;AP_lat&quot;), all.y=T)
saveRDS(d2, paste0(&quot;E:/airpollutiondata/&quot;,name,&quot;.rds&quot;))
}</code></pre>
<p>Any feedback welcome, thanks.</p>

    </div>
  </div>

</article>

<div class="container">
  <nav>
  <ul class="pager">
    
    <li class="previous"><a href="/post/rshiny-weather-app/"><span
      aria-hidden="true">&larr;</span> Nudging people to make healthy behaviour choices</a></li>
    

    
    <li class="next"><a href="/post/devolvedlegislation/">Devolved parliaments and assemblies Legislation <span
      aria-hidden="true">&rarr;</span></a></li>
    
  </ul>
</nav>

</div>

<div class="article-container">
  
<section id="comments">
  <div id="disqus_thread">
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "https-www-markcherrie-net" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</section>


</div>

<footer class="site-footer">
  <div class="container">
    <p class="powered-by">

      &copy; 2019 Mark Cherrie &middot; 

      Powered by the <a href="https://github.com/gcushen/hugo-academic" target="_blank">Academic
      theme</a> for <a href="http://gohugo.io" target="_blank">Hugo</a>.

      <span class="pull-right" aria-hidden="true">
        <a href="#" id="back_to_top">
          <span class="button_icon">
            <i class="fa fa-chevron-up fa-2x"></i>
          </span>
        </a>
      </span>

    </p>
  </div>
</footer>

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js" integrity="sha512-jGsMH83oKe9asCpkOVkBnUrDDTp8wl+adkB2D+//JtlxO4SrLoJdhbOysIFQJloQFD+C4Fl1rMsQZF76JjV0eQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.2/imagesloaded.pkgd.min.js" integrity="sha512-iHzEu7GbSc705hE2skyH6/AlTpOfBmkx7nUqTLGzPYR+C1tRaItbRlJ7hT/D3YQ9SV0fqLKzp4XY9wKulTBGTw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.19.1/TweenMax.min.js" integrity="sha512-Z5heTz36xTemt1TbtbfXtTq5lMfYnOkXM2/eWcTTiLU01+Sw4ku1i7vScDc8fWhrP2abz9GQzgKH5NGBLoYlAw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.19.1/plugins/ScrollToPlugin.min.js" integrity="sha512-CDeU7pRtkPX6XJtF/gcFWlEwyaX7mcAp5sO3VIu/ylsdR74wEw4wmBpD5yYTrmMAiAboi9thyBUr1vXRPA7t0Q==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha512-iztkobsvnjKfAtTNdHkGVjAYTrrtlC7mGp/54c40wowO7LhURYl3gVzzcEqGl/qKXQltJ2HwMrdLcNUdo+N/RQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js" integrity="sha512-VDBOIlDbuC4VWxGJNmuFRQ0Li0SKkDpmGyuhAG5LTDLd/dJ/S0WMVxriR2Y+CyPL5gzjpN4f/6iqWVBJlht0tQ==" crossorigin="anonymous"></script>
    
    <script src="/js/hugo-academic.js"></script>
    

    
    
      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>

      

      

      <script>hljs.initHighlightingOnLoad();</script>
    

    
    

  </body>
</html>

